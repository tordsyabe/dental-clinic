<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout/head :: head"></head>
<body>

<div class="container-fluid">

    <div class="row">

        <!-- SIDEBAR -->
        <div th:replace="fragments/sidebar :: sidebar"></div>
        <!-- MAIN CONTENT -->
        <div class="col-11 offset-1 my-4 pl-0 pr-5">

            <!-- MAIN CONTENT HEADER -->
            <div th:replace="fragments/patientName :: patientName"></div>

            <div th:replace="fragments/contentNav :: contentNav"></div>

            <div class="dropdown-divider"></div>
            <!-- END MAIN CONTENT HEADER -->

            <!-- MAIN CONTENT DETAILS -->

            <div class="row mt-4">
                <!-- PATIENT DETAILS -->

                <div class="col-sm-3">
                    <div th:replace="fragments/patientForm :: patientForm"></div>

                    <form th:action="@{/uploadProfileImage/}" method="post" enctype="multipart/form-data">
                        <input type="hidden" th:value="${patient.id}" name="patientId">
                        <input type="file" name="file" id="upload-image" accept="image/*"
                               onchange="loadFile(event)">

                        <input type="submit" value="Upload" id="profileUploadButton">
                    </form>
                </div>

                <!-- END PATIENT DETAILS -->

                <!-- PATIENT PROCEDURES -->
                <div class="col">
                    <h5 class="mb-4 text-muted">Latest Procedures</h5>
                    <div class="card mb-4 procedure-card">
                        <div class="card-body">

                            <div class="row" th:each="procedure : ${#lists.sort(patient.procedures, procedureDate)}"
                                 th:if="${patient.procedures.size() > 0}">


                                <div class="col-sm-2">
                                    <span th:text="${procedure.date}" id="visitDay">Today</span><br>
                                    <small class="text-muted" th:text="${procedure.date}"
                                           id="visitDate"></small>
                                </div>

                                <div class="col-sm-10 text-center">
                                    <div class="card mb-3" th:data-procedure-card="${procedure.id}">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-1">
                                                    <i
                                                            id="procedureIcon"
                                                            th:class="${procedure.paid == true ? 'fa fa-check-circle fa-lg' : 'fa fa-circle fa-lg'}"
                                                            th:style="${procedure.paid == false ? 'color: #222' : 'color: #3498db'}"></i>
                                                </div>


                                                <div class="col-8">
                                                    <div class="row" th:text="${procedure.description}"></div>

                                                    <div class="row">
                                                        <small class="text-muted" th:text="${procedure.category}"></small>

                                                    </div>
                                                </div>

                                                <div class="col-3" th:if="${!procedure.paid}">
                                                    <a class="btn btn-info" id="create-invoice-btn"
                                                            th:data-procedure-id="${procedure.id}">Create
                                                        Invoice
                                                    </a>
                                                </div>

                                                <div class="col-1"></div>

                                                <div class="col-11 mt-4 pl-0" th:if="${!procedure.paid}" th:data-invoice-form-id="${procedure.id}">
                                                    <form class="form-inline justify-content-between" th:id="${'invoice-form-' + procedure.id}"
                                                          th:onsubmit="|return submitProcedureInvoice(event, '${procedure.id}')|">
                                                        <input type="hidden" th:value="${patient.id}" id="comPatientId">
                                                        <div class="form-group input-group-sm">
                                                            <label class="text-muted pr-2" for="payment"><small>Payment Amount</small></label>
                                                            <input type="text" class="form-control"
                                                                   required
                                                                   placeholder="Amount"
                                                                   id="payment"
                                                                   name="payment"
                                                                   th:value="${procedure.cost}"
                                                                   style="background-color: #393939 !important"
                                                            >
                                                            <div class="invalid-feedback">
                                                                Payment amount is required.
                                                            </div>

                                                        </div>

                                                        <div class="form-group input-group-sm">
                                                            <label class="text-muted pr-2" for="paymentDate"><small>Payment Date</small></label>
                                                            <input type="date" class="form-control"
                                                                   required
                                                                   id="paymentDate"
                                                                   name="paymentDate"
                                                                   style="background-color: #393939 !important"
                                                            >
                                                            <div class="invalid-feedback">
                                                                Payment date is required.
                                                            </div>

                                                        </div>
                                                        <a class="btn btn-secondary btn-sm" th:onclick="|handleCloseInvoiceForm('${procedure.id}')|">Cancel</a>
                                                        <button class="btn btn-primary btn-sm" type="submit" id="submit-invoice">Invoice</button>
<!--                                                        <i class="fa fa-minus icon-button mr-3" ></i>-->

                                                    </form>
                                                </div>

                                            </div>

                                        </div>
                                    </div>


                                </div>

                            </div>

                            <div class="d-flex flex-column justify-content-center align-items-center"
                                 style="height: 100%;" th:unless="${!patient.procedures.isEmpty()}">
                                <h5 class="text-muted mb-5">No Procedures</h5>
                                <a class="btn btn-info" th:href="@{'/patient/procedures/' + ${patient.id}}"
                                   id="addProcedures">Add Procedures</a>
                            </div>


                        </div>


                    </div>

                    <!-- END PATIENT PROCEDURES -->

                    <!-- PATIENT HEALTH NOTES -->
                    <h5 class="mb-4 text-muted">Health Notes</h5>
                    <div class="card procedure-card">

                        <div class="card-body">


                            <div class="row mb-3">

                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between align-items-center px-2">
                                        <h6 class="card-subtitle">Complaints</h6>
                                        <i class="fa fa-plus icon-button" id="addComplaint"></i>
                                    </div>

                                    <div th:replace="fragments/forms/complaint :: complaintForm"></div>


                                    <div class="complaint-list" th:if="${patient.complaints.size() > 0}">
                                        <div class="card mt-3" th:data-comp-id="${complaint.id}"
                                             th:each="complaint : ${#lists.sort(patient.complaints, complaintDate)}">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-sm-10">
                                                        <p class="mb-0" th:text="${complaint.description}"></p>
                                                        <small class="text-muted" th:text="${complaint.date}"></small>
                                                    </div>
                                                    <div class="col-sm-2 d-flex justify-content-center align-items-center">
                                                        <i class="fa fa-pencil icon-button" style="display: none;"></i>
                                                        <i class="fa fa-trash icon-button"
                                                           th:onclick="|handleDeleteComplaint('${complaint.id}')|"
                                                           style="display: none;"></i>

                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="complaint-list" th:unless="${patient.complaints.size() > 0}">
                                        <p class="text-muted mt-3" id="noComplaintP">No Complaints</p>
                                    </div>

                                </div>

                                <div class="col-sm-6" style="height: 100%;">
                                    <div style="height: 50%;">
                                    <div class="d-flex justify-content-between align-items-center px-2">
                                        <h6 class="card-subtitle">Allergies</h6>
                                        <i class="fa fa-plus icon-button" id="addAllergy"></i>
                                    </div>
                                    <ul class="mt-2" style="list-style: none; padding-left: 30px;" th:if="${patient.allergies.size() > 0}">
                                        <li class="py-1" th:each="allergy : ${patient.allergies}">
                                            <i class="fa fa-check-circle pr-2" style="color: #3498db;"></i>
                                            <span th:text="${allergy.description}"></span>
                                        </li>
                                    </ul>

                                        <div class="allergy-list" th:unless="${patient.allergies.size() > 0}">
                                            <p class="text-muted mt-3" id="noAllergiesP">No Allergies</p>
                                        </div>


                                    </div>

                                    <div class="dropdown-divider"></div>

                                    <div>
                                    <div class="d-flex justify-content-between align-items-center px-2 mt-3">
                                        <h6 class="card-subtitle">Medical History</h6>
                                        <i class="fa fa-plus icon-button" id="addHistory"></i>
                                    </div>
                                    <ul class="mt-2" style="list-style: none; padding-left: 30px;">
                                        <li class="py-1"><i class="fa fa-check-circle pr-2" style="color: #3498db;"></i>Heart Surgery 10 years ago.</li>

                                    </ul>
                                    </div>
                                </div>

                            </div>


                        </div>
                    </div>

                    <!-- END PATIENT HEALTH NOTES -->

                </div>
            </div>


            <!-- END MAIN CONTENT DETAILS -->
        </div>
        <!-- MAIN CONTENT -->
    </div>

</div>

<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/details.js}"></script>
<script>
    const visitDates = document.querySelectorAll("#visitDate");
    const visitDays = document.querySelectorAll("#visitDay");

    const hiddenBirthDAte = document.getElementById("hiddenBirthDAte").value;

    document.getElementById("birthDate").value = hiddenBirthDAte;

    formatWeekDay(visitDays);
    formatNamedDate(visitDates);
</script>
</body>
</html>